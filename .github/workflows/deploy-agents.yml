# ============================================
# Galderma TrackWise AI Autopilot Demo
# Agent Deployment Workflow (100% AgentCore - S3 ZIP)
# ============================================
#
# ARCHITECTURE: Deploys agents as ZIP files to S3
# AgentCore Runtime automatically picks up new code via S3 triggers
#
# Code deployment path:
#   agents/{agent-name}/agent.zip â†’ S3://artifacts-bucket/agents/{agent-name}/agent.zip
#   backend/ â†’ S3://artifacts-bucket/backend/simulator.zip
#

name: Deploy Agents

on:
  push:
    branches: [main]
    paths:
      - 'agents/**'
      - 'backend/**'
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to deploy (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - simulator
          - observer
          - case-understanding
          - recurring-detector
          - compliance-guardian
          - resolution-composer
          - inquiry-bridge
          - writeback
          - memory-curator
          - csv-pack

# Prevent concurrent terraform operations on the same state
concurrency:
  group: terraform-dev
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: "176545286005"
  ARTIFACTS_BUCKET: "galderma-trackwise-dev-artifacts-176545286005"
  PYTHON_VERSION: "3.12"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build and Deploy Agents as ZIP files
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-agents:
    name: Deploy Agents to S3
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    strategy:
      matrix:
        include:
          # TrackWise Simulator (Backend)
          - name: simulator
            source_path: backend
            s3_prefix: backend
            zip_name: simulator.zip
          # 9 Strands Agents
          - name: observer
            source_path: agents/observer
            s3_prefix: agents/observer
            zip_name: agent.zip
          - name: case-understanding
            source_path: agents/case_understanding
            s3_prefix: agents/case-understanding
            zip_name: agent.zip
          - name: recurring-detector
            source_path: agents/recurring_detector
            s3_prefix: agents/recurring-detector
            zip_name: agent.zip
          - name: compliance-guardian
            source_path: agents/compliance_guardian
            s3_prefix: agents/compliance-guardian
            zip_name: agent.zip
          - name: resolution-composer
            source_path: agents/resolution_composer
            s3_prefix: agents/resolution-composer
            zip_name: agent.zip
          - name: inquiry-bridge
            source_path: agents/inquiry_bridge
            s3_prefix: agents/inquiry-bridge
            zip_name: agent.zip
          - name: writeback
            source_path: agents/writeback
            s3_prefix: agents/writeback
            zip_name: agent.zip
          - name: memory-curator
            source_path: agents/memory_curator
            s3_prefix: agents/memory-curator
            zip_name: agent.zip
          - name: csv-pack
            source_path: agents/csv_pack
            s3_prefix: agents/csv-pack
            zip_name: agent.zip

    steps:
      - uses: actions/checkout@v4

      - name: Check if agent should be deployed
        id: check
        run: |
          if [[ "${{ inputs.agent }}" == "all" || "${{ inputs.agent }}" == "" || "${{ inputs.agent }}" == "${{ matrix.name }}" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check.outputs.should_deploy == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        if: steps.check.outputs.should_deploy == 'true'
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.5.14"

      - name: Configure AWS Credentials
        if: steps.check.outputs.should_deploy == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies and create deployment package
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          echo "ðŸ“¦ Building deployment package for ${{ matrix.name }}..."

          cd ${{ matrix.source_path }}

          # Install dependencies to a temporary directory
          mkdir -p .package
          uv pip install --target .package -r pyproject.toml 2>/dev/null || \
          uv pip install --target .package . 2>/dev/null || \
          echo "No dependencies to install"

          # Create ZIP with all source code and dependencies
          cd .package 2>/dev/null && zip -r9 ../deployment.zip . 2>/dev/null && cd .. || true

          # Add source code to ZIP (overwriting any conflicts)
          if [[ -f deployment.zip ]]; then
            # Add source files
            zip -r9 deployment.zip . -x ".package/*" -x "*.pyc" -x "__pycache__/*" -x ".git/*" -x "*.egg-info/*" -x ".pytest_cache/*" -x ".ruff_cache/*"
          else
            # No dependencies, just zip source
            zip -r9 deployment.zip . -x "*.pyc" -x "__pycache__/*" -x ".git/*" -x "*.egg-info/*" -x ".pytest_cache/*" -x ".ruff_cache/*"
          fi

          # Rename to expected name
          mv deployment.zip ${{ matrix.zip_name }}

          echo "âœ… Created ${{ matrix.zip_name }} ($(du -h ${{ matrix.zip_name }} | cut -f1))"

      - name: Upload to S3
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          echo "â˜ï¸ Uploading ${{ matrix.name }} to S3..."

          aws s3 cp \
            ${{ matrix.source_path }}/${{ matrix.zip_name }} \
            s3://${{ env.ARTIFACTS_BUCKET }}/${{ matrix.s3_prefix }}/${{ matrix.zip_name }} \
            --content-type "application/zip"

          echo "âœ… Uploaded to s3://${{ env.ARTIFACTS_BUCKET }}/${{ matrix.s3_prefix }}/${{ matrix.zip_name }}"

      - name: Verify Upload
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          aws s3 ls s3://${{ env.ARTIFACTS_BUCKET }}/${{ matrix.s3_prefix }}/${{ matrix.zip_name }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Trigger AgentCore Runtime Update
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  update-agentcore:
    name: Update AgentCore Runtimes
    runs-on: ubuntu-latest
    needs: deploy-agents
    if: inputs.agent == 'all' || inputs.agent == ''

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Trigger AgentCore Update via Terraform
        working-directory: infra/environments/dev
        run: |
          echo "ðŸ”„ Triggering AgentCore Runtime update..."

          # Initialize Terraform
          terraform init -backend=true

          # Apply only the agentcore_runtime module with retry logic
          # The CODE_VERSION environment variable in each runtime uses the S3 etag
          # When the ZIP file changes, the etag changes, triggering a redeployment
          MAX_RETRIES=3
          RETRY_DELAY=30
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt/$MAX_RETRIES..."
            if terraform apply -auto-approve -target=module.agentcore_runtime; then
              echo "âœ… AgentCore Runtimes updated successfully"
              exit 0
            else
              echo "âš ï¸ Attempt $attempt failed"
              if [ $attempt -lt $MAX_RETRIES ]; then
                echo "Waiting ${RETRY_DELAY}s before retry (runtime may be recovering from UPDATE_FAILED)..."
                sleep $RETRY_DELAY
                # Refresh state to pick up any recovered runtimes
                terraform refresh -target=module.agentcore_runtime || true
              fi
            fi
          done
          echo "âŒ All $MAX_RETRIES attempts failed"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "## Agent Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Agent | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| simulator | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| observer | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| case-understanding | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| recurring-detector | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| compliance-guardian | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| resolution-composer | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| inquiry-bridge | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| writeback | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| memory-curator | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| csv-pack | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** 100% AgentCore Runtime (S3 ZIP deployment)" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
