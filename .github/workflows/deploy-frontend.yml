# ============================================
# Galderma TrackWise AI Autopilot Demo
# Frontend Deployment Workflow (S3 + CloudFront)
# ============================================

name: Deploy Frontend

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

# Prevent concurrent deployments to same environment
concurrency:
  group: deploy-frontend-${{ inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: "176545286005"
  NODE_VERSION: "20"

jobs:
  # ─────────────────────────────────────────────
  # Build Frontend
  # ─────────────────────────────────────────────
  build:
    name: Build Frontend
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install

      - name: Configure AWS Credentials (for Terraform output)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false

      - name: Initialize Terraform
        working-directory: infra/environments/${{ inputs.environment || 'dev' }}
        run: terraform init -backend=true

      - name: Get API URL from Terraform
        id: get_api_url
        working-directory: infra/environments/${{ inputs.environment || 'dev' }}
        run: |
          # Get API URL from Terraform outputs
          API_URL=$(terraform output -raw api_proxy_function_url 2>/dev/null || echo "")
          if [[ -n "$API_URL" ]]; then
            echo "✅ Got API URL from Terraform: $API_URL"
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          else
            echo "⚠️ API URL not available from Terraform (may need to run deploy-infrastructure first)"
            echo "api_url=" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Build for production
        working-directory: frontend
        env:
          # Use API URL from Terraform, then vars, then fallback
          VITE_API_URL: ${{ steps.get_api_url.outputs.api_url || vars.API_URL || '' }}
          VITE_WS_URL: ${{ vars.WS_URL || '' }}
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # ─────────────────────────────────────────────
  # Deploy to S3 + CloudFront
  # ─────────────────────────────────────────────
  deploy:
    name: Deploy to S3
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ inputs.environment || 'dev' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          BUCKET_NAME="galderma-trackwise-${{ inputs.environment || 'dev' }}-frontend-${{ env.AWS_ACCOUNT_ID }}"

          echo "Deploying to s3://${BUCKET_NAME}..."

          # Sync build artifacts to S3
          aws s3 sync dist/ s3://${BUCKET_NAME}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

          # Upload index.html with no-cache
          aws s3 cp dist/index.html s3://${BUCKET_NAME}/index.html \
            --cache-control "no-cache, no-store, must-revalidate"

          echo "✅ Deployed to S3"

      - name: Invalidate CloudFront Cache
        run: |
          DISTRIBUTION_ID="${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}"

          if [[ -n "$DISTRIBUTION_ID" ]]; then
            echo "Invalidating CloudFront cache..."
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
            echo "✅ CloudFront cache invalidated"
          else
            echo "⚠️ No CloudFront distribution ID configured"
          fi

      - name: Output Deployment URL
        run: |
          echo "## Frontend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: galderma-trackwise-${{ inputs.environment || 'dev' }}-frontend-${{ env.AWS_ACCOUNT_ID }}" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ vars.CLOUDFRONT_URL }}" ]]; then
            echo "- **URL**: ${{ vars.CLOUDFRONT_URL }}" >> $GITHUB_STEP_SUMMARY
          fi
